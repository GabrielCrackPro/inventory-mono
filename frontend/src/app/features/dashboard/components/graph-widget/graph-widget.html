<z-card
  class="overflow-hidden relative"
  zTitle="Activity Graph"
  zDescription="Track your progress over time"
>
  <!-- Settings icon in top-right -->
  @if(!showOptions()) {
  <div class="absolute top-4 right-4 z-20">
    <z-button
      zType="text"
      iconName="lucideSettings"
      iconClasses="text-muted-foreground hover:text-foreground"
      [iconSize]="16"
      (click)="toggleOptions()"
      class="transition-all duration-300 hover:scale-110 active:scale-95"
    />
  </div>
  }

  <!-- Header with stats -->
  <div class="flex items-center justify-between mb-4 transition-all duration-300">
    <div class="flex items-center gap-3 flex-1 min-w-0">
      @if(hasData() && !showOptions()) {
      <div
        class="flex items-center gap-2 text-xs flex-wrap animate-in fade-in slide-in-from-left-2 duration-300"
      >
        @if(metric() === 'activities') {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-indigo-500/10 border border-indigo-500/20 transition-all duration-200 hover:bg-indigo-500/15 hover:scale-105"
        >
          <span class="font-semibold text-indigo-600 dark:text-indigo-400 transition-colors">{{
            totalActivities()
          }}</span>
          <span class="text-indigo-600/70 dark:text-indigo-400/70 transition-colors"
            >activities</span
          >
        </div>
        } @else if(metric() === 'items') {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-emerald-500/10 border border-emerald-500/20 transition-all duration-200 hover:bg-emerald-500/15 hover:scale-105"
        >
          <span class="font-semibold text-emerald-600 dark:text-emerald-400 transition-colors">{{
            totalItems()
          }}</span>
          <span class="text-emerald-600/70 dark:text-emerald-400/70 transition-colors">items</span>
        </div>
        } @else {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-primary/10 border border-primary/20 transition-all duration-200 hover:bg-primary/15 hover:scale-105"
        >
          <span class="font-semibold text-foreground transition-colors">{{
            totalActivities() + totalItems()
          }}</span>
          <span class="text-muted-foreground transition-colors">total</span>
        </div>
        }
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-muted/50 transition-all duration-200 hover:bg-muted/70 hover:scale-105"
        >
          <span class="font-semibold text-foreground transition-colors">{{ avgPerDay() }}</span>
          <span class="text-muted-foreground transition-colors">avg/day</span>
        </div>
        @if(trend() !== 0) {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md transition-all duration-200 hover:scale-105"
          [class]="
            trend() > 0
              ? 'bg-emerald-500/10 border border-emerald-500/20 hover:bg-emerald-500/15'
              : 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/15'
          "
        >
          <span
            class="font-semibold transition-colors"
            [class]="
              trend() > 0
                ? 'text-emerald-600 dark:text-emerald-400'
                : 'text-red-600 dark:text-red-400'
            "
          >
            {{ trend() > 0 ? '+' : '' }}{{ trend().toFixed(0) }}%
          </span>
          <span
            class="text-sm transition-all duration-300"
            [class]="
              trend() > 0
                ? 'text-emerald-600 dark:text-emerald-400'
                : 'text-red-600 dark:text-red-400'
            "
          >
            {{ trend() > 0 ? '↑' : '↓' }}
          </span>
        </div>
        }
      </div>
      }
    </div>

    @if(showOptions()) {
    <div
      class="absolute inset-0 z-30 flex flex-col gap-3 animate-in fade-in zoom-in-95 duration-300 p-6 rounded-lg bg-card/95 backdrop-blur-sm border border-border shadow-lg overflow-y-auto"
    >
      <!-- Close button -->
      <button
        (click)="toggleOptions()"
        class="absolute top-4 right-4 p-1.5 rounded-md text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all duration-200 hover:scale-110 active:scale-95 z-10"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
      <!-- Primary Controls -->
      <div class="grid grid-cols-1 gap-2.5">
        <div class="space-y-1">
          <label
            class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
            >View</label
          >
          <z-segmented
            [zDefaultValue]="metric()"
            zSize="sm"
            [zOptions]="graphViewOptions()"
            (zChange)="setMetric($event)"
            class="w-full"
          />
        </div>

        <div class="space-y-1">
          <label
            class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
            >Period</label
          >
          <z-segmented
            zSize="sm"
            [zDefaultValue]="period()"
            [zOptions]="graphPeriodOptions()"
            (zChange)="setPeriod($event)"
            class="w-full"
          />
        </div>

        <div class="space-y-1">
          <label
            class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
            >Chart Type</label
          >
          <z-segmented
            zSize="sm"
            [zDefaultValue]="chartType()"
            [zOptions]="chartTypeOptions()"
            (zChange)="setChartType($event)"
            class="w-full"
          />
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-border/50"></div>

      <!-- Display Options -->
      <div class="space-y-1">
        <label
          class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
          >Display</label
        >
        <div class="grid grid-cols-2 gap-2">
          <button
            (click)="toggleDataLabels()"
            class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 active:scale-95"
            [class]="
              showDataLabels()
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'bg-card text-muted-foreground border border-border hover:bg-muted'
            "
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
              />
            </svg>
            <span class="text-[10px]">Labels</span>
          </button>

          <button
            (click)="toggleGridLines()"
            class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 active:scale-95"
            [class]="
              showGridLines()
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'bg-card text-muted-foreground border border-border hover:bg-muted'
            "
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
              />
            </svg>
            <span class="text-[10px]">Grid</span>
          </button>

          @if(metric() === 'both') {
          <button
            (click)="toggleStacked()"
            class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 active:scale-95 col-span-2"
            [class]="
              stacked()
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'bg-card text-muted-foreground border border-border hover:bg-muted'
            "
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
              />
            </svg>
            <span class="text-[10px]">Stacked</span>
          </button>
          }
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-border/50"></div>

      <!-- Style Options -->
      <div class="space-y-2">
        <label
          class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
          >Style</label
        >

        <div class="flex items-center justify-between gap-3">
          <span class="text-xs text-muted-foreground shrink-0">Colors</span>
          <div class="flex gap-1.5">
            <button
              (click)="setColorScheme('default')"
              class="w-9 h-9 rounded-lg border-2 transition-all duration-200 hover:scale-110 active:scale-95 shadow-sm relative overflow-hidden"
              [class]="
                colorScheme() === 'default'
                  ? 'border-primary ring-2 ring-primary/30'
                  : 'border-border/60 hover:border-border'
              "
              style="
                background: linear-gradient(135deg, rgb(99, 102, 241) 50%, rgb(16, 185, 129) 50%);
              "
            >
              @if(colorScheme() === 'default') {
              <div class="absolute inset-0 flex items-center justify-center bg-black/20">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              }
            </button>
            <button
              (click)="setColorScheme('monochrome')"
              class="w-9 h-9 rounded-lg border-2 transition-all duration-200 hover:scale-110 active:scale-95 shadow-sm relative overflow-hidden"
              [class]="
                colorScheme() === 'monochrome'
                  ? 'border-primary ring-2 ring-primary/30'
                  : 'border-border/60 hover:border-border'
              "
              style="
                background: linear-gradient(135deg, rgb(100, 116, 139) 50%, rgb(148, 163, 184) 50%);
              "
            >
              @if(colorScheme() === 'monochrome') {
              <div class="absolute inset-0 flex items-center justify-center bg-black/20">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              }
            </button>
            <button
              (click)="setColorScheme('vibrant')"
              class="w-9 h-9 rounded-lg border-2 transition-all duration-200 hover:scale-110 active:scale-95 shadow-sm relative overflow-hidden"
              [class]="
                colorScheme() === 'vibrant'
                  ? 'border-primary ring-2 ring-primary/30'
                  : 'border-border/60 hover:border-border'
              "
              style="
                background: linear-gradient(135deg, rgb(236, 72, 153) 50%, rgb(59, 130, 246) 50%);
              "
            >
              @if(colorScheme() === 'vibrant') {
              <div class="absolute inset-0 flex items-center justify-center bg-black/20">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              }
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between gap-3">
          <span class="text-xs text-muted-foreground shrink-0">Animation</span>
          <div class="flex gap-1 bg-card rounded-lg p-0.5 border border-border/60 shadow-sm">
            <button
              (click)="setAnimationSpeed('fast')"
              class="px-3 py-1 rounded-md text-[10px] font-medium transition-all duration-200"
              [class]="
                animationSpeed() === 'fast'
                  ? 'bg-primary text-primary-foreground shadow-sm'
                  : 'text-muted-foreground hover:bg-muted'
              "
            >
              Fast
            </button>
            <button
              (click)="setAnimationSpeed('normal')"
              class="px-2 py-1 rounded text-[10px] font-medium transition-all duration-200"
              [class]="
                animationSpeed() === 'normal'
                  ? 'bg-primary text-primary-foreground'
                  : 'bg-background text-muted-foreground border border-border hover:bg-muted'
              "
            >
              Normal
            </button>
            <button
              (click)="setAnimationSpeed('slow')"
              class="px-2 py-1 rounded text-[10px] font-medium transition-all duration-200"
              [class]="
                animationSpeed() === 'slow'
                  ? 'bg-primary text-primary-foreground'
                  : 'bg-background text-muted-foreground border border-border hover:bg-muted'
              "
            >
              Slow
            </button>
          </div>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Chart container -->
  <div class="w-full relative transition-all duration-300">
    @if(loading()) {
    <div
      class="w-full h-40 sm:h-44 flex items-center justify-center animate-in fade-in duration-300"
    >
      <div class="flex flex-col items-center gap-2 text-muted-foreground">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        <span class="text-xs animate-pulse">Loading data...</span>
      </div>
    </div>
    } @else {
    <div class="animate-in fade-in zoom-in-95 duration-500">
      <!-- @ts-ignore - BaseChartDirective type is too strict, but this works at runtime -->
      <canvas
        baseChart
        class="w-full h-40 sm:h-44 transition-all duration-500"
        [class.opacity-50]="!hasData()"
        [class.scale-95]="!hasData()"
        [type]="getChartType()"
        [data]="{ labels: labels(), datasets: datasets() }"
        [options]="options()"
      ></canvas>
    </div>

    @if (!hasData()) {
    <div
      class="absolute inset-0 z-10 flex flex-col items-center justify-center gap-2 rounded-md border border-dashed border-border/60 bg-background/50 backdrop-blur-sm pointer-events-none animate-in fade-in zoom-in-95 duration-300"
    >
      <svg
        class="w-12 h-12 text-muted-foreground/40 animate-in fade-in zoom-in-90 duration-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
        />
      </svg>
      <div class="text-center animate-in fade-in slide-in-from-bottom-2 duration-500 delay-100">
        <p class="text-sm font-medium text-muted-foreground">No data yet</p>
        <p class="text-xs text-muted-foreground/60 mt-1">
          Start adding items or activities to see your progress
        </p>
      </div>
    </div>
    } }
  </div>
</z-card>
