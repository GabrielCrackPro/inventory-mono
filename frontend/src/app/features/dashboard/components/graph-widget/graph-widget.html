<z-card
  class="overflow-hidden relative"
  zTitle="Activity Graph"
  zDescription="Track your progress over time"
>
  <!-- Settings icon in top-right -->
  @if(!showOptions()) {
  <div class="absolute top-4 right-4 z-20">
    <z-button
      zType="text"
      iconName="lucideSettings"
      iconClasses="text-muted-foreground hover:text-foreground"
      [iconSize]="16"
      (click)="toggleOptions()"
      class="transition-all duration-300 hover:scale-110 active:scale-95"
    />
  </div>
  }

  <!-- Header with stats -->
  <div class="flex items-center justify-between mb-4 transition-all duration-300">
    <div class="flex items-center gap-3 flex-1 min-w-0">
      @if(hasData() && !showOptions()) {
      <div
        class="flex items-center gap-2 text-xs flex-wrap animate-in fade-in slide-in-from-left-2 duration-300"
      >
        @if(metric() === 'activities') {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md [background:color-mix(in_srgb,var(--chart-1)_10%,transparent)] border border-[color-mix(in_srgb,var(--chart-1)_20%,transparent)] transition-all duration-200 hover:[background:color-mix(in_srgb,var(--chart-1)_15%,transparent)] hover:scale-105"
        >
          <span class="font-semibold text-chart-1 transition-colors">{{ totalActivities() }}</span>
          <span class="text-indigo-600/70 dark:text-indigo-400/70 transition-colors"
            >activities</span
          >
        </div>
        } @else if(metric() === 'items') {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-emerald-500/10 border border-emerald-500/20 transition-all duration-200 hover:bg-emerald-500/15 hover:scale-105"
        >
          <span class="font-semibold text-emerald-600 dark:text-emerald-400 transition-colors">{{
            totalItems()
          }}</span>
          <span class="text-emerald-600/70 dark:text-emerald-400/70 transition-colors">items</span>
        </div>
        } @else {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-primary/10 border border-primary/20 transition-all duration-200 hover:bg-primary/15 hover:scale-105"
        >
          <span class="font-semibold text-foreground transition-colors">{{
            totalActivities() + totalItems()
          }}</span>
          <span class="text-muted-foreground transition-colors">total</span>
        </div>
        }
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-muted/50 transition-all duration-200 hover:bg-muted/70 hover:scale-105"
        >
          <span class="font-semibold text-foreground transition-colors">{{ avgPerDay() }}</span>
          <span class="text-muted-foreground transition-colors">avg/day</span>
        </div>
        @if(trend() !== 0) {
        <div
          class="flex items-center gap-1.5 px-2.5 py-1 rounded-md transition-all duration-200 hover:scale-105"
          [class]="
            trend() > 0
              ? 'bg-emerald-500/10 border border-emerald-500/20 hover:bg-emerald-500/15'
              : 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/15'
          "
        >
          <span
            class="font-semibold transition-colors"
            [class]="
              trend() > 0
                ? 'text-emerald-600 dark:text-emerald-400'
                : 'text-red-600 dark:text-red-400'
            "
          >
            {{ trend() > 0 ? '+' : '' }}{{ trend().toFixed(0) }}%
          </span>
          <span
            class="text-sm transition-all duration-300"
            [class]="
              trend() > 0
                ? 'text-emerald-600 dark:text-emerald-400'
                : 'text-red-600 dark:text-red-400'
            "
          >
            {{ trend() > 0 ? '↑' : '↓' }}
          </span>
        </div>
        }
      </div>
      }
    </div>

    @if(showOptions()) {
    <div
      class="absolute inset-0 z-30 flex flex-col gap-3 animate-in fade-in zoom-in-95 duration-300 p-6 rounded-lg bg-card/95 backdrop-blur-sm border border-border shadow-lg overflow-y-auto"
    >
      <!-- Close button -->
      <button
        (click)="toggleOptions()"
        class="absolute top-4 right-4 p-1.5 rounded-md text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all duration-200 hover:scale-110 active:scale-95 z-10"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
      <!-- Primary Controls -->
      <div class="grid grid-cols-1 gap-2.5">
        <div class="space-y-1">
          <label
            class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
            >View</label
          >
          <z-segmented
            [zDefaultValue]="metric()"
            zSize="sm"
            [zOptions]="graphViewOptions()"
            (zChange)="setMetric($event)"
            class="w-full"
          />
        </div>

        <div class="space-y-1">
          <label
            class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
            >Period</label
          >
          <z-segmented
            zSize="sm"
            [zDefaultValue]="period()"
            [zOptions]="graphPeriodOptions()"
            (zChange)="setPeriod($event)"
            class="w-full"
          />
        </div>

        <div class="space-y-1">
          <label
            class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
            >Chart Type</label
          >
          <z-segmented
            zSize="sm"
            [zDefaultValue]="chartType()"
            [zOptions]="chartTypeOptions()"
            (zChange)="setChartType($event)"
            class="w-full"
          />
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-border/50"></div>

      <!-- Display Options -->
      <div class="space-y-1">
        <label
          class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
          >Display</label
        >
        <div class="grid grid-cols-2 gap-2">
          <button
            (click)="toggleDataLabels()"
            class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 active:scale-95"
            [class]="
              showDataLabels()
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'bg-card text-muted-foreground border border-border hover:bg-muted'
            "
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
              />
            </svg>
            <span class="text-[10px]">Labels</span>
          </button>

          <button
            (click)="toggleGridLines()"
            class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 active:scale-95"
            [class]="
              showGridLines()
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'bg-card text-muted-foreground border border-border hover:bg-muted'
            "
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
              />
            </svg>
            <span class="text-[10px]">Grid</span>
          </button>

          @if(metric() === 'both') {
          <button
            (click)="toggleStacked()"
            class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 active:scale-95 col-span-2"
            [class]="
              stacked()
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'bg-card text-muted-foreground border border-border hover:bg-muted'
            "
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
              />
            </svg>
            <span class="text-[10px]">Stacked</span>
          </button>
          }
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-border/50"></div>

      <!-- Animation Speed -->
      <div class="space-y-1.5">
        <label
          class="text-[10px] font-semibold text-muted-foreground uppercase tracking-wide pl-0.5"
          >Animation Speed</label
        >
        <div class="flex gap-1.5 bg-muted/30 rounded-lg p-1 border border-border/60">
          <button
            (click)="setAnimationSpeed('fast')"
            class="flex-1 px-3 py-2 rounded-md text-xs font-medium transition-all duration-200 hover:scale-[1.02] active:scale-95"
            [class]="
              animationSpeed() === 'fast'
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'text-muted-foreground hover:bg-background/50'
            "
          >
            Fast
          </button>
          <button
            (click)="setAnimationSpeed('normal')"
            class="flex-1 px-3 py-2 rounded-md text-xs font-medium transition-all duration-200 hover:scale-[1.02] active:scale-95"
            [class]="
              animationSpeed() === 'normal'
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'text-muted-foreground hover:bg-background/50'
            "
          >
            Normal
          </button>
          <button
            (click)="setAnimationSpeed('slow')"
            class="flex-1 px-3 py-2 rounded-md text-xs font-medium transition-all duration-200 hover:scale-[1.02] active:scale-95"
            [class]="
              animationSpeed() === 'slow'
                ? 'bg-primary text-primary-foreground shadow-sm'
                : 'text-muted-foreground hover:bg-background/50'
            "
          >
            Slow
          </button>
        </div>
      </div>

      <!-- Info Note -->
      <div class="p-3 rounded-lg bg-muted/30 border border-border/50">
        <div class="flex items-start gap-2">
          <svg
            class="w-4 h-4 text-primary shrink-0 mt-0.5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <p class="text-xs text-muted-foreground leading-relaxed">
            Chart colors automatically match your theme. Change theme in settings to update colors.
          </p>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Chart container -->
  <div class="w-full relative transition-all duration-300">
    @if(loading()) {
    <div
      class="w-full h-40 sm:h-44 flex items-center justify-center animate-in fade-in duration-300"
    >
      <div class="flex flex-col items-center gap-2 text-muted-foreground">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        <span class="text-xs animate-pulse">Loading data...</span>
      </div>
    </div>
    } @else {
    <div class="animate-in fade-in zoom-in-95 duration-500">
      <!-- @ts-ignore - BaseChartDirective type is too strict, but this works at runtime -->
      <canvas
        baseChart
        class="w-full h-40 sm:h-44 transition-all duration-500"
        [class.opacity-50]="!hasData()"
        [class.scale-95]="!hasData()"
        [type]="getChartType()"
        [data]="{ labels: labels(), datasets: datasets() }"
        [options]="options()"
      ></canvas>
    </div>

    @if (!hasData()) {
    <div
      class="absolute inset-0 z-10 flex flex-col items-center justify-center gap-2 rounded-md border border-dashed border-border/60 bg-background/50 backdrop-blur-sm pointer-events-none animate-in fade-in zoom-in-95 duration-300"
    >
      <svg
        class="w-12 h-12 text-muted-foreground/40 animate-in fade-in zoom-in-90 duration-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
        />
      </svg>
      <div class="text-center animate-in fade-in slide-in-from-bottom-2 duration-500 delay-100">
        <p class="text-sm font-medium text-muted-foreground">No data yet</p>
        <p class="text-xs text-muted-foreground/60 mt-1">
          Start adding items or activities to see your progress
        </p>
      </div>
    </div>
    } }
  </div>
</z-card>
